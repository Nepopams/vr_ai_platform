# Интеграция HomeTask ↔ AI Platform

Этот документ фиксирует минимальный интеграционный контракт для HomeTask и AI Platform (LangGraph).
Он описывает, как формировать запросы, как интерпретировать ответы и где проходят границы ответственности.

## Основные схемы (контракты)

- CommandDTO: `contracts/schemas/command.schema.json`
- DecisionDTO: `contracts/schemas/decision.schema.json`
- Версия контрактов: `contracts/VERSION`

## Формирование CommandDTO

Команда отправляется в виде JSON-объекта, полностью соответствующего схеме CommandDTO.
Ключевые требования:

- `command_id`: уникальный идентификатор команды (используйте для идемпотентности).
- `user_id`: пользователь-инициатор.
- `timestamp`: ISO-8601 дата/время.
- `text`: исходная пользовательская фраза.
- `capabilities`: список допустимых действий для этой команды.
- `context`: доменный контекст (см. `docs/integration/context_v1.md`).

Минимальные примеры CommandDTO находятся в `docs/integration/examples/*.json`.

## Вызов Decision API

**HTTP:** `POST /decide`

Рекомендуемые заголовки:

- `Content-Type: application/json`

Пример запроса:

```bash
curl -sS http://localhost:8000/decide \
  -H 'Content-Type: application/json' \
  -d @docs/integration/examples/create_task_start_job.json
```

## Выбор стратегии маршрутизации решений

По умолчанию используется стратегия v1 (поведение не меняется).
Чтобы включить скелет RouterV2, установите флаг окружения:

```bash
DECISION_ROUTER_STRATEGY=v2
```

## Интерпретация DecisionDTO

Ответ DecisionDTO всегда содержит `action` и `payload`, соответствующие схеме.
Важно различать:

### `start_job`

`action = "start_job"` означает, что AI Platform предлагает начать выполнение задания.
В `payload` содержатся:

- `job_id`: идентификатор задания.
- `job_type`: тип задания (`create_task`, `add_shopping_item`, `unknown`).
- `proposed_actions` (опционально): предложения по деталям (см. ниже).
- `ui_message` (опционально): текст для UI.

### `clarify`

`action = "clarify"` означает, что для продолжения нужны уточнения.
В `payload` содержатся:

- `question`: вопрос пользователю.
- `options` (опционально): варианты ответа.
- `missing_fields` (опционально): перечень недостающих полей.
- `job_id` (опционально): идентификатор контекста задания.

## Работа с `proposed_actions`

`proposed_actions` — это **предложение**, а не команда к выполнению.
HomeTask может:

- принять предложение и отобразить/выполнить;
- частично применить;
- проигнорировать и запросить уточнение.

AI Platform **не выполняет** эти действия сама — ответственность за исполнение лежит на HomeTask.

## Идемпотентность и ретраи (ответственность HomeTask)

- Используйте стабильный `command_id` для повторных отправок одной и той же команды.
- При сетевых ошибках допустимы ретраи с тем же `command_id`.
- Нельзя менять `command_id` при повторной отправке одной и той же команды.
- Ответственность за дедупликацию и безопасные ретраи полностью на стороне HomeTask.

## AI Platform НЕ гарантирует

- выполнение действий: платформа лишь возвращает решение;
- отсутствие `clarify` даже при схожих командах;
- неизменяемость `job_type` при повторной интерпретации разных команд;
- пригодность решения без учета актуальности вашего `context`;
- корректность при нарушении схемы запроса или при пустом/неконсистентном контексте.

## LLM Model Policy (ADR-003)

- Это внутренний механизм платформы, не часть внешних контрактов.
- В MVP предполагается file-based реестр (llm-policy.yaml) и эскалация cheap → repair → reliable.
- До реализации политики допускается временная provider-level конфигурация, но любые расширения должны ориентироваться на ADR-003.

## Связанные документы

- Контекст: `docs/integration/context_v1.md`
- Примеры: `docs/integration/examples/*.json`
